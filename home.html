<!DOCTYPE html>
<html lang="es" class="antialiased">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contención | Central de Inteligencia</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- D3.js para el gráfico de nodos -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Iconos Phosphor -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
        },
        extend: {
          colors: {
            dark: {
              900: '#000000',
              800: '#121212',
              700: '#1C1C1E', // Apple Dark Gray
              600: '#2C2C2E',
            },
            light: {
              50: '#FBFBFD', // Apple Light Background
              100: '#F5F5F7',
              200: '#E5E5EA',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out forwards',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Estilos personalizados para el Glassmorphism y detalles finos */
    body {
      transition: background-color 0.5s ease, color 0.5s ease;
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .dark .glass-panel {
      background: rgba(28, 28, 30, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Estilos del grafo D3 */
    #graph-container {
      user-select: none;
      -webkit-user-select: none;
    }

    #graph-container canvas {
      outline: none;
    }

    /* Estilos mejorados para el cursor del grafo */
    #graph-container svg {
      cursor: grab;
      touch-action: none;
      /* Mejorar gestos en móviles */
    }

    #graph-container svg:active {
      cursor: grabbing;
    }

    .article-card {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
    }

    .article-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.1);
    }

    .dark .article-card:hover {
      box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.5);
    }

    /* Ocultar scrollbar pero permitir scroll */
    .hide-scroll::-webkit-scrollbar {
      display: none;
    }

    .hide-scroll {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>

<body
  class="bg-light-50 text-gray-900 dark:bg-dark-900 dark:text-gray-100 selection:bg-gray-900 selection:text-white dark:selection:bg-white dark:selection:text-black">

  <!-- Navegación Fija -->
  <nav
    class="fixed top-0 w-full z-50 glass-panel border-b border-gray-200 dark:border-gray-800 transition-colors duration-500">
    <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="assets/images/logo.png" alt="Nexus Logo" class="h-8 w-auto rounded-md">
        <span class="font-semibold tracking-tight text-lg">Contención: Psiquiátrico</span>
      </div>

      <div class="flex items-center gap-6">
        <a href="index.html"
          class="text-sm font-medium text-gray-500 hover:text-black dark:text-gray-400 dark:hover:text-white transition-colors">Sitio
          Oficial</a>
        <a href="RodrigoDCP.html"
          class="text-sm font-medium text-gray-500 hover:text-black dark:text-gray-400 dark:hover:text-white transition-colors">Sobre
          mí</a>

        <!-- Botón Modo Oscuro -->
        <button id="theme-toggle"
          class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors focus:outline-none"
          aria-label="Cambiar tema">
          <i class="ph ph-moon text-xl block dark:hidden"></i>
          <i class="ph ph-sun text-xl hidden dark:block"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Sección Principal: El Grafo -->
  <header class="relative pt-32 pb-10 px-6 overflow-hidden">
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-12 items-center">

      <!-- Texto Introductorio -->
      <div class="lg:col-span-1 z-10 animate-fade-in">
        <div
          class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-800 text-xs font-semibold mb-6 uppercase tracking-wider text-gray-600 dark:text-gray-300">
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
          Sistema Activo
        </div>
        <h1 class="text-5xl md:text-6xl font-bold leading-tight tracking-tight mb-6">
          Terminal de <br>
          <span class="text-gray-400 dark:text-gray-600">Investigación.</span>
        </h1>
        <p class="text-lg text-gray-600 dark:text-gray-400 leading-relaxed mb-8">
          Bienvenido a la base de datos oficial de <strong>Contención: Psiquiátrico</strong>. Aquí podrás explorar el
          proceso de desarrollo, consultar expedientes clasificados y analizar los reportes técnicos del incidente.
        </p>
        <div class="flex gap-4">
          <button onclick="resetFilter()"
            class="px-6 py-3 bg-black dark:bg-white text-white dark:text-black rounded-full font-medium text-sm hover:opacity-80 transition-opacity">
            Ver todo
          </button>
          <button
            class="px-6 py-3 border border-gray-300 dark:border-gray-700 rounded-full font-medium text-sm hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            Explorar tags
          </button>
        </div>
      </div>

      <!-- Contenedor del Grafo (Canvas Visual) -->
      <div
        class="lg:col-span-2 h-[400px] lg:h-[500px] relative rounded-3xl bg-gray-100/50 dark:bg-gray-800/30 border border-gray-200 dark:border-gray-800 overflow-hidden shadow-inner">
        <div id="graph-container" class="w-full h-full"></div>
        <div class="absolute bottom-4 right-4 text-xs text-gray-400 font-mono pointer-events-none">
          // GRAPH_VIS_V2.0
        </div>
      </div>
    </div>
  </header>

  <!-- Barra de Filtros Activos -->
  <div id="filter-bar" class="max-w-7xl mx-auto px-6 mb-8 hidden">
    <div class="flex items-center gap-4">
      <span class="text-sm text-gray-500">Filtrando por:</span>
      <span id="active-filter-tag"
        class="px-4 py-1.5 rounded-full bg-gray-900 text-white dark:bg-white dark:text-black text-sm font-medium"></span>
      <button onclick="resetFilter()" class="text-sm text-gray-500 hover:text-red-500 underline">Limpiar</button>
    </div>
  </div>

  <!-- Grid de Contenido -->
  <main class="max-w-7xl mx-auto px-6 pb-32">
    <div class="flex items-end justify-between mb-10 border-b border-gray-200 dark:border-gray-800 pb-4">
      <h2 class="text-2xl font-semibold tracking-tight">Publicaciones Recientes</h2>
      <div class="text-sm text-gray-500 font-mono" id="post-count">Cargando...</div>
    </div>

    <div id="articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      <!-- Las tarjetas se insertan aquí vía JS -->
    </div>
  </main>

  <!-- Footer Minimalista -->
  <footer
    class="border-t border-gray-200 dark:border-gray-800 py-12 bg-white dark:bg-black transition-colors duration-500">
    <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-6">
      <div class="text-sm text-gray-500 dark:text-gray-500">
        Copyright &copy; 2026 Rodrigo David Cañas Pérez. Todos los derechos reservados.
      </div>
      <div class="flex gap-6">
        <a href="https://github.com/RodrigoDCP" target="_blank"
          class="text-gray-400 hover:text-black dark:hover:text-white transition-colors"><i
            class="ph ph-github-logo text-xl"></i></a>
        <a href="https://www.youtube.com/@COPS-i2d" target="_blank"
          class="text-gray-400 hover:text-black dark:hover:text-white transition-colors"><i
            class="ph ph-youtube-logo text-xl"></i></a>
        <a href="https://www.instagram.com/keny_hdr?igsh=aXVrbmIwcGs1aHQ1" target="_blank"
          class="text-gray-400 hover:text-black dark:hover:text-white transition-colors"><i
            class="ph ph-instagram-logo text-xl"></i></a>
      </div>
    </div>
  </footer>

  <!-- Scripts Logic -->
  <script>
    // --- DATA LOADING ---
    let articles = [];

    async function fetchArticles() {
      try {
        const response = await fetch('reportes/reportes.json');
        if (!response.ok) throw new Error('Error al cargar reportes.json');
        articles = await response.json();
        return articles;
      } catch (error) {
        console.error("No se pudo cargar el índice de reportes:", error);
        return [];
      }
    }

    // --- GRAPH LOGIC (D3.js) ---
    let graphSvg, graphSimulation, graphNode, graphLink;
    let nodes = [];
    let links = [];
    const width = document.getElementById('graph-container').clientWidth;
    const height = document.getElementById('graph-container').clientHeight;

    function prepareGraphData() {
      const allTags = [...new Set(articles.flatMap(a => a.tags))];
      nodes = [
        ...articles.map(a => ({ id: `article-${a.id}`, label: a.title, type: 'article', group: 1, data: a })),
        ...allTags.map(t => ({ id: `tag-${t}`, label: t, type: 'tag', group: 2 }))
      ];
      links = [];
      articles.forEach(a => {
        a.tags.forEach(t => {
          links.push({ source: `article-${a.id}`, target: `tag-${t}` });
        });
      });
    }

    function initGraph() {
      if (!articles.length) return;
      prepareGraphData();
      const container = d3.select("#graph-container");
      container.selectAll("*").remove(); // Limpiar previo

      graphSvg = container.append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("viewBox", [0, 0, width, height]);

      // --- SIMULACIÓN FÍSICA ---
      graphSimulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(80))
        .force("charge", d3.forceManyBody().strength(-200))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide(30));

      // --- ESTRUCTURA PARA ZOOM ---
      // 1. Grupo principal que recibirá las transformaciones
      const zoomGroup = graphSvg.append("g");

      // 2. Definir el comportamiento de zoom
      const zoom = d3.zoom()
        .scaleExtent([0.5, 5]) // Límites de zoom
        .on("zoom", (event) => {
          zoomGroup.attr("transform", event.transform);
        });

      // 3. Aplicar zoom al SVG
      graphSvg.call(zoom);

      // --- ELEMENTOS DEL GRAFO ---
      // Dibujar líneas (enlaces) dentro del zoomGroup
      graphLink = zoomGroup.append("g")
        .attr("stroke", "#999")
        .attr("stroke-opacity", 0.3)
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke-width", 1);

      // Dibujar nodos dentro del zoomGroup
      graphNode = zoomGroup.append("g")
        .selectAll("circle")
        .data(nodes)
        .join("g")
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

      // Círculos de los nodos
      graphNode.append("circle")
        .attr("r", d => d.type === 'article' ? 6 : 10) // Tags más grandes
        .attr("fill", d => d.type === 'article' ? "var(--node-article)" : "var(--node-tag)")
        .attr("class", "transition-colors duration-300 cursor-pointer hover:scale-125")
        .on("click", (event, d) => handleNodeClick(d));

      // Etiquetas de texto
      graphNode.append("text")
        .text(d => d.label)
        .attr("x", 12)
        .attr("y", 4)
        .attr("font-family", "Inter, sans-serif")
        .attr("font-size", d => d.type === 'article' ? "10px" : "12px")
        .attr("font-weight", d => d.type === 'article' ? "400" : "600")
        .attr("fill", "var(--node-text)")
        .attr("pointer-events", "none") // Click through text
        .style("opacity", 0.7);

      graphSimulation.on("tick", () => {
        graphLink
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        graphNode
          .attr("transform", d => `translate(${d.x},${d.y})`);
      });

      updateGraphTheme();
    }

    // Funciones de Drag & Drop para D3
    function dragstarted(event) {
      if (!event.active) graphSimulation.alphaTarget(0.3).restart();
      event.sourceEvent.stopPropagation(); // Prevenir selección de texto
      event.subject.fx = event.subject.x;
      event.subject.fy = event.subject.y;
    }

    function dragged(event) {
      event.subject.fx = event.x;
      event.subject.fy = event.y;
    }

    function dragended(event) {
      if (!event.active) graphSimulation.alphaTarget(0);
      event.subject.fx = null;
      event.subject.fy = null;
    }

    // --- UI LOGIC ---

    function renderArticles(filterTag = null) {
      const grid = document.getElementById('articles-grid');
      const countLabel = document.getElementById('post-count');
      grid.innerHTML = '';

      const filteredArticles = filterTag
        ? articles.filter(a => a.tags.includes(filterTag))
        : articles;

      countLabel.innerText = `${filteredArticles.length} Documentos`;

      if (filteredArticles.length === 0) {
        grid.innerHTML = `<div class="col-span-3 text-center py-20 text-gray-400">No se encontraron artículos con ese tag.</div>`;
        return;
      }

      filteredArticles.forEach(art => {
        // Crear tags HTML
        const tagsHtml = art.tags.map(t =>
          `<span class="inline-block px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 text-[10px] uppercase tracking-wider font-semibold rounded-md mr-2">${t}</span>`
        ).join('');

        const card = `
                    <a href="reportes/reportes.html?id=${art.id}" class="article-card group flex flex-col h-full p-8 bg-white dark:bg-dark-700 rounded-[32px] border border-gray-100 dark:border-gray-800 relative overflow-hidden transition-all">
                        <div class="absolute top-0 right-0 p-8 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="ph ph-arrow-up-right text-2xl text-gray-400 dark:text-white"></i>
                        </div>
                        <div class="mb-6 flex items-center gap-2 text-xs font-medium text-gray-400">
                            <i class="ph ph-calendar-blank"></i> ${art.date}
                        </div>
                        <h3 class="text-xl font-bold mb-3 text-gray-900 dark:text-gray-100 group-hover:underline decoration-1 underline-offset-4">${art.title}</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-6 flex-grow">${art.excerpt}</p>
                        <div class="mt-auto">
                            ${tagsHtml}
                        </div>
                    </a>
                `;
        grid.innerHTML += card;
      });
    }

    function handleNodeClick(d) {
      if (d.type === 'tag') {
        filterByTag(d.label);
      } else if (d.type === 'article') {
        // En un caso real, iría a la URL
        console.log("Navigating to:", d.label);
      }
    }

    function filterByTag(tag) {
      document.getElementById('filter-bar').classList.remove('hidden');
      document.getElementById('active-filter-tag').innerText = tag;

      // Efecto visual en grafo
      graphNode.style('opacity', n => {
        if (n.label === tag) return 1; // El tag seleccionado
        if (n.type === 'article' && n.data.tags.includes(tag)) return 1; // Artículos relacionados
        return 0.1; // Resto atenuado
      });

      graphLink.attr('stroke-opacity', l => {
        if (l.target.label === tag) return 0.6;
        return 0.05;
      });

      renderArticles(tag);
    }

    function resetFilter() {
      document.getElementById('filter-bar').classList.add('hidden');
      renderArticles(null);

      // Reset grafo
      graphNode.style('opacity', 1); // La opacidad se define por CSS o tema
      graphLink.attr('stroke-opacity', 0.3);
      updateGraphTheme(); // Re-aplicar colores correctos
    }

    // --- DARK MODE LOGIC ---
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    function updateGraphTheme() {
      // Sincronizar con el estado real del DOM
      const isDark = html.classList.contains('dark');
      const root = document.documentElement;

      // Definir variables CSS dinámicamente para D3
      if (isDark) {
        root.style.setProperty('--node-article', '#4B5563'); // Gray 600
        root.style.setProperty('--node-tag', '#F5F5F7'); // Whiteish
        root.style.setProperty('--node-text', '#D1D5DB'); // Gray 300
      } else {
        root.style.setProperty('--node-article', '#9CA3AF'); // Gray 400
        root.style.setProperty('--node-tag', '#111827'); // Black
        root.style.setProperty('--node-text', '#374151'); // Gray 700
      }

      // Actualizar elementos existentes si ya se dibujaron
      if (graphNode && !graphNode.empty()) {
        graphNode.select("circle")
          .attr("fill", d => d.type === 'article' ? "var(--node-article)" : "var(--node-tag)");
        graphNode.select("text")
          .attr("fill", "var(--node-text)");
      }
    }

    // Start Asynchronous Loading
    async function startApp() {
      // 1. Cargar preferencia de tema antes de todo
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        html.classList.add('dark');
      } else {
        html.classList.remove('dark');
      }

      // 2. Cargar datos
      await fetchArticles();
      renderArticles();

      // 3. Inicializar gráfico
      initGraph();
      // Pequeño delay adicional para re-ajustar si es necesario
      setTimeout(updateGraphTheme, 50);
    }

    themeToggle.addEventListener('click', () => {
      html.classList.toggle('dark');
      if (html.classList.contains('dark')) {
        localStorage.theme = 'dark';
      } else {
        localStorage.theme = 'light';
      }
      updateGraphTheme();
    });

    window.addEventListener('resize', () => {
      initGraph();
    });

    startApp();

  </script>
</body>

</html>